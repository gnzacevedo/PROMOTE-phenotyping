---
title: "PROMOTE Phenotyping - CD4 analysis"
author: "Gonzalo Acevedo"
date: "`r Sys.Date()`"
html_document:
    toc: yes
    toc_float: yes
    toc_levels: 5
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background.  

- Data was manually gated on FCSExpress and exported already compensated.

## Set up.  

```{r}
library(tidyverse)
library(parallel)
library(magrittr)
library(dplyr)
library(flowCore)
library(openCyto)
library(ggplot2)
library(patchwork)
library(ggcyto)
library(ggrepel)
library(flowWorkspace)
library(clustree)
library(foreach)
library(doParallel)
library(parallel)
library(ggrastr)
library(ggsignif)
library(ggbeeswarm)
suppressMessages(library(CATALYST))
library(tidygraph)
library(ggraph)

data.dir <- '/Users/gacevedo/Library/CloudStorage/Box-Box/Flow Transfer - Shared/Data and analyses/PROMOTE phenotyping/all_CD4'
```



## Prepare the data

- Because SpectroFlo made files with their fluors in different $PxN, I need to load the data into a cytoset class object (agnostic of order of the channels) and then convert it to a flowSet.  

```{r}
fcs.files <- dir(data.dir, pattern='.fcs', ignore.case=TRUE, full.names=TRUE, recursive=TRUE)
cs <- load_cytoset_from_fcs(files=fcs.files, transformation = NULL)
fs <- cytoset_to_flowSet(cs)
autoplot(fs, 'FSC-A','SSC-A')
```

Delete  the cytoset and clean up RAM.  

```{r}
rm(cs)
gc()
```

Replace hyphens with dots in colnames.  

```{r}
colnames(fs) %<>% gsub('-', '\\.', .)
colnames(fs)
```


```{r}

#Need to get rid of spaces in marker names to avoid problems when plotting
markernames(fs) %<>% gsub(' ', '', .)

#The autofluorescence channel does not have a marker name assigned to it
af.key.N <- keyword(fs[[1]]) %>% 
  .[grep('\\$P[[:digit:]]+N', names(.), value=TRUE)] %>%
  unlist() %>%
  grep('AF.A',., value=TRUE) %>%
  names(.)

af.key.S <- gsub('N$','S$', af.key.N)

fs <- fsApply(fs, FUN=function(ff) {
  keyword(ff)[[af.key.S]] <- 'Autofluorescence'
  return(ff)
}) 

markernames(fs) <- c(markernames(fs), 'AF.A'='Autofluorescence')

fs
```

### Transform

-   Visualize the data to visually select cofactors for ArcSinh
transformation.

```{r, warning=FALSE, fig.width=8, eval=FALSE}
plots <- list()
plist.list <- list()

for(i in markernames(fs)){
  
  plist <- list()
  
  fluorx <- markernames(fs) %>% .[.==i] %>% names(.)
  
  for(cof in c(1, 1e2, 2e2, 5e2, 1e3, 2e3, 5e3, 1e4)){ #delete   
    
    bx <- 1/cof
    tfx <- arcsinhTransform(b=bx)
    
    tl <- transformList(from=c(fluorx), 
                        tfun=list(tfx))
    
    p <- fs %>%
      ###
      transform(tl) %>%
      fsApply(FUN=function(ff) ff[sample(1:nrow(ff), 5e3), ]) %>%
      ###
      ggplot(aes(x=.data[[fluorx]], 
                 y=FSC.A,
                 color=name))+
      geom_point(size=0.1, alpha=0.3)+
      scale_y_continuous(labels = function(x) format(x, scientific = TRUE))+
      theme_classic()+
      ggtitle(paste0('b 1/', cof))+
      labs(x=paste(fluorx, i), y='FSC.A')+
      theme(aspect.ratio=1, legend.position='none')
    
    #print(p)
    plist[[paste0('b 1/', cof)]] <- p
    
    plist.list[[i]] <- ggpubr::ggarrange(plotlist=plist, ncol=4, nrow=2)
  } #delete
  
}

plist.list %>% print
```

```{r}
cofactors <- c('Autofluorescence'=5e3,
               'KLRG1'=1e3,
               'Dump'=2e3,
               'S1PR1'=1e3,
               'CXCR5'=5e2,
               'gdTCR'=5e2,
               'CD137'=1e3,
               'CX3CR1'=1e3,
               'LAG3'=5e2,
               'CD127'=2e3,
               'CD4'=5e2,
               'CD25'=5e3,
               'CD95'=5e2,
               'CD45RA'=1e3,
               'CXCR3'=2e3,
               'CCR7'=1e3,
               'CCR6'=1e3,
               'CCR4'=2e3,
               'CD161'=5e2,
               'CXCR6'=1e3,
               'CD3'=5e2,
               'CD8'=2e3,
               'PD1'=1e3,
               'CD134'=1e3,
               'CD69'=1e3,
               'Viability'=2e3,
               'CD56'=2e3
)

for(i in markernames(fs)){
  fluorx <- markernames(fs) %>% .[.==i] %>% names(.)
  bx <- 1/cofactors[i]
  tfx <- arcsinhTransform(b=bx)
  tl <- transformList(from=fluorx, 
                      tfun=tfx,
                      transformationId='arcsinhWithCofactor'
  )
  fs <- transform(fs, translist=tl)
  
  rm(fluorx, bx, tfx, tl)
  gc()
}
```


-   Visualize to check transformation

```{r}
plots <- list()
dim.combos <- list(c('Viability','CD3'), #1
                   c('CD3','Dump'), #2
                   c('CD3','gdTCR'), #3
                   c('CD4','CD8'), #4
                   c('CD45RA', 'CCR7'), #5
                   c('CD45RA', 'CD95'),
                   c('CD25','CD127'),
                   c('CXCR3','CCR4'),
                   c('CCR6','CCR4'),
                   c('CXCR5','PD1'),
                   c('CXCR6','S1PR1'),
                   c('CX3CR1','S1PR1'),
                   c('LAG3','CD161'),
                   c('CXCR6','PD1'),
                   c('CXCR6','KLRG1'),
                   c('LAG3','S1PR1')
                   
)

plist <- list()

for(i in 1:length(dim.combos)){
  
  x <- dim.combos[[i]][1]
  fluorx <- markernames(fs) %>% .[.==x] %>% names(.)
  
  y <- dim.combos[[i]][2]
  fluory <- markernames(fs) %>% .[.==y] %>% names(.)
  
  p <- fs %>%
    ###
    fsApply(FUN=function(ff) ff[sample(1:nrow(ff), 5e3), ]) %>%
    ###
    ggplot(aes(x=.data[[fluorx]], 
               y=.data[[fluory]], 
               color=name))+
    geom_point(size=0.1, alpha=0.2)+
    labs(x=paste(fluorx, x), y=paste(fluory,y))+
    theme_classic()+
    theme(aspect.ratio=1, legend.position='none')
  
  plist[[paste(x, y)]] <- p
  
}

plist %>% print
```

- Save transformed `flowSet` and .fcs files.  

```{r, eval=FALSE}
saveRDS(fs, file='CD4/CD4_transformedFlowSet.RDS')

ff.to.fcs <- function(ff, dir.to='./CD4/CD4_transformed'){
  if(!dir.exists(dir.to)){
    dir.create(dir.to)
  }
  file.to <- paste0(dir.to, '/', keyword(ff)[['GUID']])
  write.FCS(ff, filename=file.to)
  cat('Saved:', file.to, '\n')
}

fsApply(fs, ff.to.fcs)
```

## Metadata.  

Start from the names in the `flowSet`.  

```{r}
if(!exists('fs')){
  fs <- readRDS('CD4_transformedFlowSet.RDS')
}

md <- pData(fs)

md %<>% 
  mutate('Batch'=gsub('_CD4_.+$', '', name),
         'Donor'=gsub('(.+ )(\\S+)(\\.fcs)', '\\2', name))

md
```

- Read in P3 data.  

```{r}
p3file1 <- '/Users/gacevedo/GitHub/PROMOTE-P3-exploration/NoChemoDPP3SpecimenswithPQlevels.dta'
p3data1 <- haven::read_dta(p3file1) %>%
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>%
  dplyr::filter(id %in% md$Donor) %>%
  select(id, date, ageatsample, dob, gender, Txarm, PQCat, malariaincidencePI) %>%
  distinct() %>%
  mutate(id=as.character(id))

p3data1 %>% slice_sample(n=10)
```

```{r}
p3file2 <- '/Users/gacevedo/GitHub/PROMOTE-P3-exploration/(PRAS - PROMOTE P3) Patient level database HIV unexposed through intervention with final adherence data.dta'
p3data2 <- haven::read_dta(p3file2) %>%
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>%
  dplyr::filter(id %in% md$Donor) %>%
  select(id, adcatFINAL) %>%
  distinct() %>%
  mutate(id=as.character(id))
p3data2 %>% slice_sample(n=10)
```

```{r}
expmd <- readxl::read_xlsx(paste0(data.dir,'/expt_md.xlsx'), 1)
expmd
```

```{r}
md %<>%
  left_join(expmd, by=c('Donor','Batch')) %>%
  left_join(p3data1, by=c('Donor'='id', 'date'='date')) %>%
  left_join(p3data2, by=c('Donor'='id'))

md
```

- Add simplified categories that will aid visualization later.  

```{r}
md %<>%
  rowwise() %>%
  mutate(Tx=ifelse(is.na(Txarm), 'ANC', as.character(Txarm)),
         Adherence=ifelse(is.na(Txarm), 'ANC',
                          ifelse(Txarm=='No chemoprevention', 'NoChemop',
                                 ifelse(adcatFINAL=='DP Score >=2', 'High', 'NotHigh')))
  ) %>%
  ungroup()
md
```


```{r}
pData(fs) <- cbind(pData(fs), md %>% select(-name))
rm(p3data1, p3data2, expmd)
```

- Save flowSet with metadata.  

```{r, eval=FALSE}
saveRDS(fs, file='CD4/CD4_transformedFlowSet_withMetadata.RDS')
```

```{r}
fs <- readRDS('CD4/CD4_transformedFlowSet_withMetadata.RDS')
md <- pData(fs)
```

## Normalization   

- Identify channels that need normalization.  

```{r}
fs.normalizers <- fs[pData(fs)[['Donor']]=='ANC51']

plist <- list()
for(c in colnames(fs)){
  p <- ggplot(fs.normalizers, aes(x=.data[[c]], color=Batch, group=name))+
    scale_color_manual(values=c('firebrick','cyan4'))+
    theme_classic()+
    ggtitle(c)+
    geom_density()
  plist[[c]] <- p
  #cat('plotted', c, '\n')
}
walk(plist, print)
```

- I will leave alone the scatters, LDB, CD3, CD4, CD8 and gdTCR as they won't be used for clustering.  
- BV650 and PE-Cy7 don't seem to require normalization. 

```{r}
channels <- colnames(fs)[c(8,10:12,15:18,20:23,25:28,31:33)]
channels
```

- Prepare normalization.  

```{r}
library(CytoNorm)

transf.fcs.files <- list.files('CD4/CD4_transformed/', pattern='\\.fcs$', ignore.case=TRUE)
ndata <- data.frame(File=transf.fcs.files,
                    Path=paste0('CD4/CD4_transformed/',transf.fcs.files)) %>%
  mutate(Type=ifelse(grepl('ANC51', File), 'Train', 'Validation')) %>%
  left_join(md %>% select(name, Batch), 
            by=c('File'='name'))
ndata
```

```{r}
train_data <- dplyr::filter(ndata, Type == "Train")
validation_data <- dplyr::filter(ndata, Type == "Validation")

fsom <- prepareFlowSOM(train_data$Path,
                       channels,
                       nCells = 2e4,
                       FlowSOM.params = list(xdim = 10,
                                             ydim = 10,
                                             nClus = 20,
                                             scale = FALSE),
                       transformList = NULL,
                       seed = 1)

cvs <- testCV(fsom,
              cluster_values = c(5:20)) 
```

```{r}
cvs.df <- data.frame('k'=integer(0), 'cv'=numeric(0))
for(i in names(cvs$cvs)){
  cvs.df <- rbind(cvs.df, data.frame('k'=rep(as.integer(i), length(cvs$cvs[[i]])),
                                     'cv'=cvs$cvs[[i]]))
}
cvs.df %>%
  ggplot(aes(x=as.factor(k), y=cv))+
  geom_boxplot()+
  geom_jitter()+
  theme_classic()
```
- Because all CV are below 1.5, clustering before normalization is appropriate.  k=5 seems to yield the lowest CVs overall.

-Train the model:  

```{r, eval=FALSE}
model <- CytoNorm.train(files = train_data$Path,
                        labels = train_data$Batch,
                        channels = channels,
                        transformList = NULL,
                        FlowSOM.params = list(nCells = 2e4, 
                                              xdim = 10,
                                              ydim = 10,
                                              nClus = 5,
                                              scale = FALSE),
                        normMethod.train = QuantileNorm.train,
                        normParams = list(nQ = 101,
                                          goal = "R2"),
                        outputDir = 'Normalized',
                        clean=TRUE,
                        seed = 1,
                        verbose = TRUE,
                        recompute = TRUE,
                        plot=TRUE)
```

- Normalize the rest of the samples.  

```{r, eval=FALSE}
CytoNorm.normalize(model = model,
                   files = ndata$Path,
                   labels = ndata$Batch,
                   transformList = NULL,
                   transformList.reverse = NULL,
                   normMethod.normalize = QuantileNorm.normalize,
                   write=TRUE,
                   outputDir = "CD4/CD4_Normalized",
                   prefix = "CD4_Norm_",
                   clean = TRUE,
                   verbose = TRUE)
```

### Check normalization.  

-First with the normalizer samples.  

```{r}
fs.n<- read.flowSet(path='CD4/CD4_Normalized', pattern='fcs', transformation=NULL)

md.n <- pData(fs.n)

md.n %<>%
  mutate('Batch'=gsub('(.+Norm_)(.+)(_CD4_.+$)', '\\2', name),
         'Donor'=gsub('(.+ )(\\S+)(\\.fcs)', '\\2', name)) %>%
  left_join(md %>% select(-name), by=c('Donor','Batch'))

pData(fs.n)  <- cbind(pData(fs.n), md.n %>% select(-name))

fs.normalizers.n <- fs.n[pData(fs)[['Donor']]=='ANC51']

before.data <- fsApply(fs.normalizers, FUN=function(x) as.data.frame(exprs(x)))
after.data <- fsApply(fs.normalizers.n, FUN=function(x) as.data.frame(exprs(x)))

for(i in 1:length(after.data)){
  before.data[[i]][['Batch']] <- pData(fs.normalizers)[['Batch']][i]
  before.data[[i]][['name']] <- pData(fs.normalizers)[['name']][i]
  after.data[[i]][['Batch']] <- pData(fs.normalizers.n)[['Batch']][i]
  after.data[[i]][['name']] <- pData(fs.normalizers.n)[['name']][i]
}

before.data %<>% bind_rows()
after.data %<>% bind_rows()

cl <- makeCluster(8)
registerDoParallel(cl)

#for(c in channels){

plist <- foreach(c=channels, .packages=c('flowCore','ggcyto','ggplot2', 'patchwork')) %dopar% {
  
  before <- ggplot(before.data, 
                   aes(x=.data[[c]], color=Batch, group=name))+
    theme_classic()+
    ggtitle('Before')+
    geom_density()
  
  
  #after
  
  after <- ggplot(after.data,
                  aes(x=.data[[c]], color=Batch, group=name))+
    geom_density()+
    theme_classic()
  
  
  #cat('plotted', c, '\n')
  #plist[[c]] <- before/after
  
  res <- before/after
  return(res)
}

stopCluster(cl)
walk(plist, print)
```

- Create plots for all samples (writing instead of displaying to save RAM).  

```{r, eval=FALSE}
# for(c in channels){
#   before <- ggplot(fs, aes(x=.data[[c]], color=Batch, group=name))+
#     scale_color_manual(values=c('firebrick','cyan4'))+
#     theme_classic()+
#     ggtitle('Before')+
#     geom_density()
#   
#   after <- ggplot(fs.n, aes(x=.data[[c]], color=Batch, group=name))+
#     scale_color_manual(values=c('firebrick','cyan4'))+
#     theme_classic()+
#     ggtitle('After')+
#     geom_density()
#   
#   plot <- before/after
#   png(filename=paste0('CD4_Normalized/DensityPlot_',c,'.png'), width=1000, height=650)
#   print(plot)
#   dev.off()
#   rm(plot)
#   gc()
#   
#   cat('Saved plot for', c,'\n')
# }


cl <- makeCluster(10)
registerDoParallel(cl)

#for(c in channels){

plist <- foreach(c=channels, .packages=c('flowCore','ggcyto','ggplot2', 'patchwork', 'magrittr', 'tidyverse')) %dopar% {
  
  before.data <- fsApply(fs, FUN=function(x) as.data.frame(exprs(x[,c])))
  after.data <- fsApply(fs.n, FUN=function(x) as.data.frame(exprs(x[,c])))
  
  for(i in 1:length(after.data)){
    before.data[[i]][['Batch']] <- pData(fs)[['Batch']][i]
    before.data[[i]][['name']] <- pData(fs)[['name']][i]
    after.data[[i]][['Batch']] <- pData(fs.n)[['Batch']][i]
    after.data[[i]][['name']] <- pData(fs.n)[['name']][i]
  }
  
  before.data %<>% bind_rows()
  after.data %<>% bind_rows()
  
  before <- ggplot(before.data, 
                   aes(x=.data[[c]], color=Batch, group=name))+
    theme_classic()+
    ggtitle('Before')+
    geom_density()
  
  
  #after
  
  after <- ggplot(after.data,
                  aes(x=.data[[c]], color=Batch, group=name))+
    geom_density()+
    theme_classic()
  
  
  plot <- before/after
  png(filename=paste0('CD4_Normalized/DensityPlot_',c,'.png'), width=1000, height=650)
  print(plot)
  dev.off()
  rm(plot, before, after, before.data, after.data)
  gc()
  
  cat('Saved plot for', c,'\n')
}

stopCluster(cl)
```

- Save normalized `flowSet` with metadata.  

```{r}
saveRDS(fs.n, file='CD4/CD4_normFlowSet_withMetadata.RDS')
```


## CATALYST workflow. 

### Build `SingleCellExperiment`.  

-   Need to set up objects that will be built into `SingleCellExperiment`:
-- `flowSet` (ready from prior steps) 
-- `md`, a `data.frame` containing the metadata (`pData(fs)`) 
-- `panel`, a `data.frame` matching fluorochromes, markers and class of marker (type, state or none)

- Panel information   

```{r}
fs.n <- readRDS('CD4/CD4_normFlowSet_withMetadata.RDS')
panel <- data.frame('fcs_colname'=names(markernames(fs.n)),
                    'antigen'=markernames(fs.n))

additional.mkrs <- setdiff(colnames(fs.n), panel$fcs_colname)
panel <- rbind(panel, data.frame('fcs_colname'=additional.mkrs,
                                 'antigen'=additional.mkrs))

panel %<>% mutate(marker_class=ifelse(antigen %in% c('FSC.A','FSC.H',
                                                     'SSC.A','SSC.B.A','SSC.B.H','SSC.H',
                                                     'Time','Viability','CD3','Autofluorescence','Dump'), 
                                      'none','type'))

panel
```



-   Construct `SingleCellExperiment` object

```{r}
sce <- prepData(fs.n, 
                panel=panel, 
                md=md.n,
                #newer version of CATALYST has default columns that need to be overriden manually for the function to work
                md_cols = list(file="name", 
                               id='name',
                               factors=colnames(md.n)[-1]
                ), 
                panel_cols=list(channel= "fcs_colname", 
                                antigen="antigen",
                                class="marker_class"),
                transform=FALSE,
                FACS=TRUE)
sce
```

- Remove unnecessary objects and clear up RAM.  

```{r}
rm(fs, fs.n, md, model, fsom, before, after, fs.normalizers, fs.normalizers.n, p)
gc()
```

-   I need to change the 'assay' name in the SCE, because of default
values harcoded in many of the functions in the `CATALYST` package.

```{r}
names(sce@assays) <- 'exprs'
```


### MDS plots

- Check batch effect.  

```{r}
grpCols <-  c('cyan4','orange','firebrick','darkorchid4','royalblue')

fts <- panel %>% dplyr::filter(fcs_colname %in% channels) %>% pull(antigen)
fts <- c(fts, 'CCR7', 'CXCR5')

pbMDS(sce, 
      color_by='Batch', by='sample_id',
      features=fts, label_by=NULL)+
  geom_point(size=3)+
  scale_color_manual(values=grpCols)+
  theme(aspect.ratio=1)
```

- Color by Tx group.  

```{r}
pbMDS(sce, 
      color_by='Tx', by='sample_id',
      shape_by='Batch', label_by=NULL,
      features=fts)+
  geom_point(size=3)+
  scale_color_manual(values=grpCols)+
  theme(aspect.ratio=1)
```

- Color by adherence group.  

```{r}
pbMDS(sce, 
      color_by='Adherence', by='sample_id',
      shape_by='Batch', label_by=NULL,
      features=fts)+
  geom_point(size=3)+
  scale_color_manual(values=grpCols)+
  theme(aspect.ratio=1)
```

- Marker expression by adherence group.  

```{r, fig.width=9, fig.height=5}
plotExprs(sce, color_by='Adherence', features=fts)+scale_color_manual(values=grpCols)
```

### Clustering

```{r, eval=FALSE}
sce <- cluster(sce,
               features=fts, xdim=20, ydim=20,
               maxK=40, verbose=TRUE, seed=1)

saveRDS(sce, 'CD4/CD4_sce_flowsom.RDS')
```

### UMAP

```{r, eval=FALSE}
set.seed(1312)
sce <- runDR(sce, dr='UMAP', features=fts, verbose=TRUE)
saveRDS(sce, file='CD4/CD4_sce_flowsom_umap.RDS', compress=FALSE)
```

```{r}
sce <- readRDS('CD4/CD4_sce_flowsom_umap.RDS')
```


```{r, eval=FALSE}
source('code/fx_DRdf.R')
umap.df <- DRdf(sce, dr='UMAP', 
                md=c(colnames(ei(sce)), names(cluster_codes(sce)), rownames(sce)))

saveRDS(umap.df, file='CD4/CD4_UMAP_dataframe.RDS')

umap.df %>%
  slice_sample(n=10)
```


#### Marker expression

```{r}
if(!exists('umap.df')){
  umap.df <- readRDS('CD4/CD4_UMAP_dataframe.RDS')
}
```


```{r, fig.height=11}
# plotDR(sce, dr='UMAP', 
#        color_by=c('CD45RA','CCR7','CD95','CD127','CD25','CD4'))+
#   theme(panel.background=element_rect(color='black'))

markers <- c('CD45RA','CCR7','CD95','CD127','CD25','CD4',
             'CXCR3','CCR4','CCR6','CXCR5','CXCR6','CX3CR1',
             'CD161','KLRG1','S1PR1','LAG3','PD1','CD69')



plist <-mclapply(markers, mc.cores = 6,
                 FUN=function(m){ # foreach(m=markers[1:3], .packages=c('tidyverse','magrittr','ggplot2','ggrastr')) %dopar%{
                   umap.df %>%
                     slice_sample(n=1e5) %>%
                     ggplot(aes(x=UMAP1, y=UMAP2))+
                     geom_point_rast(mapping=aes(color=.data[[m]]),
                                     size=0.1)+
                     theme_classic()+
                     scale_color_viridis_c(option='magma')+
                     theme(panel.background=element_rect(color='black'),
                           aspect.ratio=1)
                 }
)

walk(plist, print)
```

## Choose metaclustering level

-   Check cluster stability to select number of metaclusters

```{r}
sce <- readRDS('CD4/CD4_sce_flowsom.RDS')
delta_area(sce)
```


```{r}
delta_area(sce)+lims(y=c(0, 0.1))+
  scale_x_continuous(breaks=waiver(), limits=c(4, 40))+
  theme(aspect.ratio=0.5)
```

```{r, fig.height=8, fig.width=7}
tree <- clustree(sce@metadata$cluster_codes, prefix='meta', 
                 node_size_range=c(2,10), node_alpha=0.5,
                 edge_width=0.5,  node_colour='sc3_stability')+
  scale_color_viridis_c(option='magma', direction = -1)
#theme(legend.position='none', axis.text=element_text(color='steelblue'))
tree
```

Plot stability over number of metaclusters 

```{r}
source('code/fx_plotMetaStability.R')
stab.box <- plotStabilityBoxes(sce)+
  theme(panel.grid.major.x=element_line())
stab.box
```

```{r, fig.width=12, fig.height=8}
stab.ribs <- plotStabilityRibbons(sce, labels.repel=TRUE)+
  geom_vline(xintercept=c(20, 22), linetype='dashed', alpha=0.4)+
  scale_x_continuous(breaks=seq.int(0, 40, 2))+
  theme(panel.grid.major.x=element_line())

stab.ribs
```


```{r}
if(!exists('umap.df')){
  umap.df <- readRDS('CD4_UMAP_dataframe.RDS')
}
```


```{r}
my.colors <- c('firebrick','seagreen','orange','darkorchid4','navy','hotpink',
               'indianred','darkseagreen','khaki','lavender','steelblue','pink',
               'darkred','yellowgreen','yellow','violet','skyblue','coral')

umap.20.22 <- umap.df %>%
  slice_sample(n=1e5) %>%
  select(UMAP1, UMAP2, meta20, meta22, meta23, meta25) %>%
  pivot_longer(cols=c(meta20, meta22, meta23, meta25), 
               names_to='Metaclustering', values_to='Cluster') %>%
  ggplot(aes(x=UMAP1, y=UMAP2, color=Cluster))+
  geom_point(size=0.2, alpha=0.2)+
  geom_label_repel(data=. %>% group_by(Metaclustering, Cluster) %>%
                     summarize(UMAP1=median(UMAP1), UMAP2=median(UMAP2)),
                   mapping=aes(label=Cluster)
  )+
  scale_color_manual(values=colorRampPalette(my.colors)(25))+
  theme_classic()+
  theme(aspect.ratio=1, legend.position='none')+
  facet_wrap('Metaclustering')

```


```{r, fig.height=9, fig.width=9}
(stab.ribs/(umap.20.22|(tree+theme(legend.position='none')+plot_layout(widths=c(3,1)))))+plot_layout(heights=c(3,5))
```


- Meta 23 seems to be the best 

```{r}
umap.df %>%
  dplyr::filter(Tx!='ANC') %>%
  slice_sample(n=1e6) %>% # filtered for faster plotting
  ggplot(aes(x=UMAP1, y=UMAP2, color=meta23))+
  geom_point(size=0.1, alpha=0.05)+
  geom_label_repel(data=.%>% group_by(Tx, meta23) %>%
                     summarize(UMAP1=median(UMAP1),
                               UMAP2=median(UMAP2)),
                   alpha=0.8, max.overlaps=100, size=3,
                   mapping=aes(label=meta23), 
                   show.legend=FALSE)+
  # guides(col=guide_legend(ncol = 8,
  #     override.aes = list(alpha = 1, size = 3)))+
  theme_classic()+
  scale_color_manual(values=colorRampPalette(my.colors)(23))+#CATALYST:::.cluster_cols)+
  theme(aspect.ratio=1, legend.position='none',
        axis.title=element_blank())+
  facet_wrap('Tx')
```


### Cluster annotation.  

```{r}
fts <- c("CD69","PD1","CXCR6",
         "CD161","CCR4","CCR6","CCR7","CXCR3","CD45RA","CD95","CD25",
         "CD127","LAG3","CX3CR1","CXCR5","S1PR1","KLRG1")

expHm <- plotExprHeatmap(sce, features = fts,
                         by = "cluster_id", k = "meta23",
                         scale = "first", q = 0.01, perc = TRUE, col_dend = TRUE, row_anno = TRUE)

expHm
```


### Cluster Abundances.  


```{r}
plotAbundances(sce, k='meta23', by='sample_id', group_by='Adherence')+
  theme(axis.text.x=element_blank())
```


```{r,fig.height=11, fig.width=9}
source('code/fx_plotAbundances.signif.R')

sce@metadata$experiment_info$Adherence %<>%
  factor(., levels=c('ANC','High','Not high','No chemop'))
grpCols <- c('ANC'='skyblue','NoChemop'='firebrick','High'='orange','NotHigh'='cyan4')
plotAbundances.signif(sce, k='meta23', group_by='Adherence', k_pal=grpCols)
```

- Same as above but without ANCs.  

```{r}
sce2 <- sce[, colData(sce)[['Adherence']] !='ANC'] #the filterSCE function was messing up the metadata

filtered.ei <- ei(sce) %>%
  dplyr::filter(Adherence!='ANC') %>%
  mutate(Txarm=factor(Tx, levels=c('No chemoprevention','Monthly DP')),
         Adherence=factor(Adherence, levels=c('NoChemop','NotHigh','High')))

sce2@metadata$experiment_info <- filtered.ei

colData(sce2) %<>% droplevels()
colData(sce2)[['Adherence']] %<>% factor(., levels=c('NoChemop','NotHigh','High'))
colData(sce2)[['Tx']] %<>% factor(., levels=c('No chemoprevention','Monthly DP'))
```


```{r, fig.height=5, fig.width=11}
tx.colors <- c('No chemoprevention'=CATALYST:::.cluster_cols[3],
               'Monthly DP'=CATALYST:::.cluster_cols[1])
abund.byTx <- plotAbundances.signif(sce2, k='meta23', group_by='Tx', k_pal=tx.colors, facets_ncol=11)+
  guides(col=guide_legend(ncol=2))+
  theme(axis.text.x=element_blank(), 
        legend.position='top')

abund.byTx
```



```{r, fig.height=6, fig.width=11}
adh.colors <- c('NoChemop'=CATALYST:::.cluster_cols[3],
                'NotHigh'= CATALYST:::.cluster_cols[2],
                'High'=CATALYST:::.cluster_cols[1])

abund.byAdh <- plotAbundances.signif(sce2, k='meta23', group_by='Adherence', 
                                     k_pal=adh.colors, facets_ncol=11)+
  guides(col=guide_legend(ncol = 3))+
  theme(axis.text.x=element_blank(), 
        legend.position='top')

abund.byAdh
```

- Same but only No chemo vs High adherence


```{r}
sce3 <- sce[, colData(sce)[['Adherence']]  %in% c('NoChemop', 'High')] #the filterSCE function was messing up the metadata

filtered.ei3 <- ei(sce) %>%
  dplyr::filter(Adherence %in% c('NoChemop', 'High')) %>%
  mutate(Txarm=factor(Tx, levels=c('No chemoprevention','Monthly DP')),
         Adherence=factor(Adherence, levels=c('NoChemop','High')))

sce3@metadata$experiment_info <- filtered.ei3

colData(sce3) %<>% droplevels()
colData(sce3)[['Adherence']] %<>% factor(., levels=c('NoChemop','High'))
colData(sce3)[['Tx']] %<>% factor(., levels=c('No chemoprevention','Monthly DP'))
```


```{r}
abund.byAdh2 <- plotAbundances.signif(sce3, k='meta23', group_by='Adherence', 
                                      k_pal=adh.colors, facets_ncol=12)+
  guides(col=guide_legend(ncol = 2))+
  theme(axis.text.x=element_blank(), 
        legend.position='top')

abund.byAdh2
```

```{r}
koi <- c(17, 19, 20, 21)

umap.df %>%
  select(meta23, all_of(fts)) %>%
  filter(meta23 %in% koi) %>%
  group_by(meta23) %>%
  summarize(across(everything(), median)) %>%
  pivot_longer(cols=where(is.numeric), names_to='Marker', values_to='Median.expr') %>%
  group_by(Marker) %>%
  ggplot(aes(y=Marker, x=meta23, fill=Median.expr))+
  scale_fill_gradientn(colors=c('navy','steelblue','lavender','khaki','orange','firebrick'))+
  geom_tile()+
  theme_classic()+coord_fixed()
```

### Bivariates. 

```{r}
dim.pairs <- list(c('CD45RA','CCR7'),
                  c('CD45RA','CD95'),
                  c('CXCR3','CXCR5'),
                  c('CCR4','CCR6'),
                  c('CX3CR1','KLRG1'),
                  c('CXCR5','PD1'),
                  c('PD1','LAG3'),
                  c('CXCR6','CD69'),
                  c('CXCR6','S1PR1'),
                  c('CD25','CD127'),
                  c('CD4','CD161'))

source()
plist <- lapply(dim.pairs, FUN=function(d) plotBivariates.highlightClusters(umap.df, dimpair=d, meta='meta23', koi=koi, bg.evts=1e6))
```

```{r, fig.width=9, fig.height=9}
ggpubr::ggarrange(plotlist=plist)
```

```{r}
dir.create('CD4/CD4_clusterBivariates')
lapply(dim.pairs, FUN=function(d) {
  fil <- paste0('CD4_clusterBivariates/', d[1], '_', d[2], '.png')
  png(filename=fil, width=200, height=200, units='px')
  print(plotBivariates.highlightClusters(umap.df, dimpair=d, koi=koi, meta='meta23', bg.evts=1e6))
  dev.off()
}
)
# png(filename='CD4_DiffAbundantK_selectBivariates.png', width = 900, height=600, units='px')
# print(ggpubr::ggarrange(plotlist=plist))
# dev.off()
```

